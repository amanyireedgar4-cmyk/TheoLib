// library.logic.js

function getCurrentUser() {
  return JSON.parse(localStorage.getItem("theolib_user"));
}

function requireLogin() {
  alert("Please sign in or sign up to continue reading.");
  window.location.href = "auth.html";
}

// ---------- BOOK ACCESS ----------

function openBook(book) {
  const user = getCurrentUser();

  if (!book.free && !user) {
    requireLogin();
    return;
  }

  if (user) {
    markAsRead(book);
  }

  window.open(book.link, "_blank");
}

// ---------- SAVE BOOK ----------

function saveBook(book) {
  const user = getCurrentUser();

  if (!user) {
    requireLogin();
    return;
  }

  const key = `savedBooks_${user.email}`;
  let saved = JSON.parse(localStorage.getItem(key)) || [];

  if (!saved.find(b => b.id === book.id)) {
    saved.push(book);
    localStorage.setItem(key, JSON.stringify(saved));
    alert("Book saved to My Library");
  } else {
    alert("Book already saved");
  }
}

// ---------- MARK AS READ ----------

function markAsRead(book) {
  const user = getCurrentUser();
  if (!user) return;

  const key = `readBooks_${user.email}`;
  let read = JSON.parse(localStorage.getItem(key)) || [];

  if (!read.find(b => b.id === book.id)) {
    read.push(book);
    localStorage.setItem(key, JSON.stringify(read));
  }
}

// ---------- HELPERS ----------

function isLoggedIn() {
  return !!getCurrentUser();
}
