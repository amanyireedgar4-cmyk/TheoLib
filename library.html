// ===== TheoLib Library Core Logic =====

// Free read control
const FREE_READ_LIMIT = 2;

// Storage keys
const STORAGE = {
  reads: "theolib_reads",
  saved: "theolib_saved",
  readBooks: "theolib_read_books"
};

// Get stored values
function getStore(key, fallback) {
  return JSON.parse(localStorage.getItem(key)) || fallback;
}

// Save to storage
function setStore(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

// Check login state (temporary)
function isLoggedIn() {
  return !!localStorage.getItem("theolib_user");
}

// Reads count
function getReadCount() {
  return getStore(STORAGE.reads, 0);
}

function incrementReads() {
  let r = getReadCount() + 1;
  setStore(STORAGE.reads, r);
  return r;
}

// Saved books
function getSaved() {
  return getStore(STORAGE.saved, []);
}

function toggleSave(bookId) {
  let saved = getSaved();
  if (saved.includes(bookId)) {
    saved = saved.filter(id => id !== bookId);
  } else {
    saved.push(bookId);
  }
  setStore(STORAGE.saved, saved);
}

// Read books
function getReadBooks() {
  return getStore(STORAGE.readBooks, []);
}

function markRead(bookId) {
  let list = getReadBooks();
  if (!list.includes(bookId)) {
    list.push(bookId);
    setStore(STORAGE.readBooks, list);
  }
}

// Read permission check
function canRead() {
  if (isLoggedIn()) return true;
  return getReadCount() < FREE_READ_LIMIT;
}

// Trigger read
function attemptRead(bookId) {
  if (!canRead()) {
    document.getElementById("loginPopup").style.display = "flex";
    return false;
  }
  incrementReads();
  markRead(bookId);
  return true;
}
